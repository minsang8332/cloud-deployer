# cloud-manager
> 간단하게 호스팅 환경을 구축하기 위한 나만의 배포 자동화 솔루션
- 경험상 호스팅 환경 구성해 놓고 비용상의 이유로 새로 만들거나 종료하거나 하는 경우가 많았음
- 트래픽은 적으므로 도메인 하나로 여러 웹서비스를 운영하고 싶음
- 주기적으로 내 리포지토리들을 탐색해서 소스코드를 최신화하여 배포하면 좋을 것 같음
- https 인증서 발급 및 갱신 자동화

## 설계하기
트래픽을 프록시가 서브도메인과 매핑된 서비스로 바이패스하도록 함

```txt
          <외부 네트워크>                   <로컬 네트워크>
클라이언트 ──> 프록시─────────> [서비스 A] <──────── 데이터베이스 ...                  
                 └────────────> [서비스 B] <────────────┘
                 └────────────> [서비스 C] <────────────┘
                 └────────────> [서비스 D] <────────────┘
                                 ....
```

### 📌 빌드 및 배포 자동화 ?

#### 1. 프록시 컨테이너
1. `git rev-parse` 명령어를 통해 로컬과 원격 저장소를 주기적으로 비교 <br>
💡 결과값을 저장소별로 파일로 저장하고 서비스 컨테이너와 공유 <br>
💡 결과값이 `-1` 인 경우 카톡 알림 <br>
💡 프록시에서 각 컨테이너 별로 명령을 전달해야 하는 애로사항이 있어 web-hook 으로는 구현이 어려워 보임

```
(-1:에러, 0:이상없음, 1:빌드시작, 2:빌드중, ...)   
```

#### 2. 서비스 컨테이너
2. 주기적으로 결과값을 확인하여 값이 `1`인 경우 `/scripts/deploy.sh` 를 실행  
💡 `/scripts/deploy.sh` 는 서비스마다 빌드과정이 상이하므로 서비스마다 구현   
💡 정상적으로 빌드되었다면 결과 값을 `0` 으로 변경   
💡 표준에러가 발생하였다면 결과 값을 `-1` 로 변경

## 계획하기
| 작업내용 | 상태 |
|-------|-----------------------|
| 환경구성 및 프록시 구현 |완료
| HTTPS 인증서 발급 및 갱신 자동화 |완료|
| 주기적으로 git 저장소를 탐색해서 소스코드 최신화 및 배포 |진행중|

## 실행하기
1. 호스팅 서버에 Docker 컨테이너 플랫폼 설치
2. `.env` 환경변수 편집 <br>
2-1. 신규 서비스 추가시 Dockerfile 추가
3. 명령어 실행
```
docker-compose up -d --build

# 💡env 파일명 변경시
docker-compose --env-file [파일명] up -d --build
```
